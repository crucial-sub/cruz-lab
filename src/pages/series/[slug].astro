---
export const prerender = false;

import BaseLayout from '@/layouts/BaseLayout.astro';
import FadeInSection from '@/components/islands/FadeInSection';
import { getSeriesBySlug, getPostsBySeries } from '@/lib/series';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

// ì‹œë¦¬ì¦ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
const series = await getSeriesBySlug(slug);

if (!series) {
  return Astro.redirect('/404');
}

// ì‹œë¦¬ì¦ˆ ë‚´ í¬ìŠ¤íŠ¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
const posts = await getPostsBySeries(series.id);

const title = `${series.name} - Series`;
const description = series.description;

// ì´ ì½ê¸° ì‹œê°„ ê³„ì‚°
const totalReadingTime = posts.reduce((sum, post) => sum + post.readingTime, 0);
---

<BaseLayout title={title} description={description}>
  <div class="py-8">
    <!-- ë’¤ë¡œê°€ê¸° -->
    <FadeInSection client:visible>
      <a
        href="/series"
        class="group mb-6 inline-flex items-center gap-2 text-text-secondary transition-colors hover:text-brand"
      >
        <svg
          class="h-4 w-4 transition-transform group-hover:-translate-x-1"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"
          ></path>
        </svg>
        ì‹œë¦¬ì¦ˆ ëª©ë¡ìœ¼ë¡œ
      </a>
    </FadeInSection>

    <!-- ì‹œë¦¬ì¦ˆ í—¤ë” -->
    <FadeInSection client:visible delay={0.1}>
      <div class="mb-8 rounded-2xl border border-border bg-gradient-to-br from-bg-card to-bg-surface p-8">
        {/* ì‹œë¦¬ì¦ˆ ì»¤ë²„ ì´ë¯¸ì§€ */}
        {
          series.coverImage && (
            <div class="mb-6 aspect-video w-full overflow-hidden rounded-xl">
              <img
                src={series.coverImage}
                alt={series.name}
                class="h-full w-full object-cover"
              />
            </div>
          )
        }

        {/* ì‹œë¦¬ì¦ˆ ì œëª© */}
        <h1 class="mb-4 text-3xl font-extrabold text-text-primary md:text-4xl">
          ğŸ“š {series.name}
        </h1>

        {/* ì‹œë¦¬ì¦ˆ ì„¤ëª… */}
        <p class="mb-6 text-lg text-text-secondary leading-relaxed">
          {series.description}
        </p>

        {/* ë©”íƒ€ ì •ë³´ */}
        <div class="flex flex-wrap items-center gap-4 text-sm text-text-secondary">
          <div class="flex items-center gap-2">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width={2}
                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
              />
            </svg>
            <span class="font-medium">ì´ {posts.length}ê°œ í¬ìŠ¤íŠ¸</span>
          </div>

          <div class="flex items-center gap-2">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width={2}
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <span>ì˜ˆìƒ ì½ê¸° ì‹œê°„: ì•½ {totalReadingTime}ë¶„</span>
          </div>
        </div>
      </div>
    </FadeInSection>

    <!-- í¬ìŠ¤íŠ¸ ëª©ë¡ (ì²´í¬ë¦¬ìŠ¤íŠ¸ í˜•íƒœ) -->
    <FadeInSection client:visible delay={0.2}>
      <div class="space-y-3">
        <h2 class="mb-4 text-xl font-bold text-text-primary">ì‹œë¦¬ì¦ˆ ëª©ì°¨</h2>

        {
          posts.map((post, index) => (
            <a
              href={`/blog/${post.slug}`}
              data-series-post-id={post.id}
              class="group block rounded-xl border border-border bg-bg-card p-4 transition-all hover:border-brand hover:shadow-lg hover:shadow-brand/10"
            >
              <div class="flex items-start gap-4">
                {/* ìˆœì„œ ë²ˆí˜¸ */}
                <div class="flex-shrink-0">
                  <div class="flex h-10 w-10 items-center justify-center rounded-full bg-brand/10 text-sm font-bold text-brand transition-colors group-hover:bg-brand group-hover:text-white">
                    {index + 1}
                  </div>
                </div>

                {/* í¬ìŠ¤íŠ¸ ì •ë³´ */}
                <div class="flex-1 min-w-0">
                  <h3 class="mb-1 font-semibold text-text-primary transition-colors group-hover:text-brand">
                    {post.title}
                  </h3>
                  <p class="mb-2 line-clamp-2 text-sm text-text-secondary">
                    {post.description}
                  </p>
                  <div class="flex items-center gap-4 text-xs text-text-secondary">
                    <span class="flex items-center gap-1">
                      <svg
                        class="h-3.5 w-3.5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width={2}
                          d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      {post.readingTime}ë¶„
                    </span>
                    <span class="flex items-center gap-1">
                      <svg
                        class="h-3.5 w-3.5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width={2}
                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                        />
                      </svg>
                      {new Date(post.pubDate).toLocaleDateString('ko-KR')}
                    </span>
                  </div>
                </div>

                {/* í™”ì‚´í‘œ */}
                <div class="flex-shrink-0 opacity-0 transition-all group-hover:translate-x-1 group-hover:opacity-100">
                  <svg
                    class="h-5 w-5 text-brand"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width={2}
                      d="M13 7l5 5m0 0l-5 5m5-5H6"
                    />
                  </svg>
                </div>
              </div>
            </a>
          ))
        }
      </div>
    </FadeInSection>

    <!-- ì‹œì‘í•˜ê¸° ë²„íŠ¼ (ì²« ë²ˆì§¸ í¬ìŠ¤íŠ¸ë¡œ) -->
    {
      posts.length > 0 && (
        <FadeInSection client:visible delay={0.3}>
          <div class="mt-8 text-center">
            <a
              href={`/blog/${posts[0].slug}`}
              class="inline-flex items-center gap-2 rounded-xl bg-brand px-8 py-4 font-semibold text-white shadow-lg shadow-brand/30 transition-all hover:shadow-xl hover:shadow-brand/40 hover:brightness-110"
            >
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width={2}
                  d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width={2}
                  d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              ì‹œë¦¬ì¦ˆ ì‹œì‘í•˜ê¸°
            </a>
          </div>
        </FadeInSection>
      )
    }
  </div>
</BaseLayout>

<script>
  // ì½ì€ í¬ìŠ¤íŠ¸ ì²´í¬ í‘œì‹œ (localStorage ê¸°ë°˜)
  // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œë§Œ ì‹¤í–‰
  if (typeof window !== 'undefined') {
    const currentUrl = new URL(window.location.href);
    const seriesSlug = currentUrl.pathname.split('/').pop();

    // localStorageì—ì„œ ì½ì€ í¬ìŠ¤íŠ¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const readPosts = JSON.parse(
      localStorage.getItem(`series-${seriesSlug}-read`) || '[]'
    );

    // ê° í¬ìŠ¤íŠ¸ì— ì²´í¬ í‘œì‹œ
    document.querySelectorAll('[data-series-post-id]').forEach((element) => {
      const postId = element.getAttribute('data-series-post-id');
      if (readPosts.includes(postId)) {
        // ì²´í¬ ì•„ì´ì½˜ ì¶”ê°€
        const checkIcon = document.createElement('div');
        checkIcon.className =
          'absolute top-2 right-2 flex h-6 w-6 items-center justify-center rounded-full bg-green-500 text-white';
        checkIcon.innerHTML = `
          <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
        `;
        (element as HTMLElement).style.position = 'relative';
        element.appendChild(checkIcon);
      }
    });
  }
</script>
